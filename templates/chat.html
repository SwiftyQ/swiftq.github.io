<!DOCTYPE html>
<head>
	<title>SwiftyQ</title>
	<meta name="apple-mobile-web-app-capable" content="yes" /> <!-- iOS fullscreen webapp -->
	<meta name="mobile-web-app-capable" content="yes" /> <!-- Android Chrome fullscreen webapp -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">

  <!-- Importing fonts -->
  <link href="https://fonts.googleapis.com/css?family=Courgette" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">

  <link rel="stylesheet" href="./static/css/inbox.css">
  <link rel = "stylesheet" href = "./static/css/chat.css">
  <!-- https://lipis.github.io/bootstrap-social/ -->
  <link rel="stylesheet" href="./static/css/bootstrap-social.css">
  <script src="https://use.fontawesome.com/6384f656d9.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>

<body style="height:100%; width: 100%;">


<div id="myModal" class="modal in" role="dialog" style = "padding-top:500px">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content" style = "background-color: gainsboro">
      <div class="modal-header">
        <h2 class="modal-title">Understood?</h2>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" style="font-size: 2.2rem">
       Take a Quiz or Leave
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" id = "quiz" data-dismiss="modal" style = "background-color: white; color: black; border-width: 1px; font-size:2rem">Take a Quiz</button>
        <button type="button" class="btn btn-default" id = "exit" style = "background-color: white; color: black; border-width: 1px; font-size:2rem" data-target="#ratingModal" data-toggle="modal" data-dismiss="modal">I'm Good</button>
      </div>
    </div>

  </div>
</div>

<div id="ratingModal" class="modal in" role="dialog" style = "padding-top:500px">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content" style = "background-color: gainsboro">
      <div class="modal-header">
        <h2 class="modal-title">Rating</h2>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" style="font-size: 2.2rem">
        <p>How much were you satisfied with the response?</p>
        <div class="text-center">
          <span class="fa fa-star under checked"></span>
          <span class="fa fa-star under checked"></span>
          <span class="fa fa-star under checked"></span>
          <span class="fa fa-star under"></span>
          <span class="fa fa-star under"></span>
        </div>
        <p>Self-evaluate your understanding</p>
        <div class="text-center" >
          <span class="fa fa-star sat checked"></span>
          <span class="fa fa-star sat checked"></span>
          <span class="fa fa-star sat checked"></span>
          <span class="fa fa-star sat"></span>
          <span class="fa fa-star sat"></span>
        </div>
        <div class="text-center"><small>Default will result in 3-points.</small></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" id = "exit" style = "background-color: white; color: black; border-width: 1px"><a class="exitanchor" href="/inbox?replied={{respondent}}&user_id={{user_id}}&under=3&sat=3&request_time={{request_time}}" style = "color: black">Save and leave</a></button>
      </div>
    </div>

  </div>
</div>

<div id="myModal2" class="modal in" role="dialog" style = "padding-top:500px">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content" style = "background-color: gainsboro">
      <div class="modal-header">
        <h4 class="modal-title">Give Her a Quiz!</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
       Hi
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" id = "quiz" data-dismiss="modal" style = "background-color: white; color: black; border-width: 1px">Take a Quiz</button>
        <div type="button" class="btn btn-default" id = "exit" style = "background-color: white; color: black; border-width: 1px"><a href="/inbox?user_id={{user_id}}" style = "color: black">I'm Good</a></div>
      </div>
    </div>

  </div>
</div>

  <div id="header text-center" style="height: 200px; width:100%; padding-top: 80px; padding-bottom: 80px">
    <h1 class="text-center" id="user_id" >
      {% if requester %}
        {{user_id}}
      {% else %}
        {{respondent}}
      {% endif %}
    </h1>
		<h2 class="container-fluid">
			{{question}}
		</h2>
    <div class="text-center"><div class = "onlinecircle text-center" style="display: inline-block;"></div><span style="font-size: 25px;">&nbsp&nbsponline</span></div>
  </div>
  <div class="w-100" style="position: relative; top: 10px; height: 5px; background-color: #eee;"></div>
  <div class="container" id="messages" style = "height: 1242px; margin-top: 20px; overflow: scroll">
  </div>
  <div class="container" id="image" style="height: 1242px; margin-top: 20px; display: none;">
    <div class="text-center"><h1>The requester uploaded the photo:</h1></div>
    <img src="static/upload/{{img}}" style="max-width: none; border-radius: 0;">
  </div>

  <div id="footer" style = "height: 250px;">
     <div class="w-100" style="height: 2px; background-color: #eee;"></div>
     <div class="row" style = "height: 100%">
      <div class = "col-9">
        <textarea id="user_msg" placeholder=" Type something.." style="font-size: 30px; width:100%; height: 100%; margin-top: 5px; bottom: 2px; border: 1.1px solid; margin: 10px;"></textarea>
      </div>
      <div class = "col-3" style="margin-top:15px;">
        <div id="send_button" class="btn btn-dark btn-block"  style="font-size:x-large">
          Send
        </div><br>
        {% if img %}
        <div id="show_image" class="btn btn-primary btn-block" style="font-size:x-large">
          Show photo
        </div> 
        {% endif %}
      </div>
    </div>
    </div>
</body>
<script type="text/javascript">
  var username = $("#user_id").text();
  console.log(username);
  $(document).ready(function(){
    var sock = io.connect('/chat');
    sock.on('connect', function(){
      var connect_string = 'new_connect';
      sock.send(connect_string,username);
    });

    sock.on('hello', function(msg){
      $('#messages').append('<li>' +'>>Hello :'+ msg + '</li>');
      console.log('Received Hello Message');
    });

    sock.on('message', function(msg){
      // console.log(type(msg));
      console.log(msg);
      if(msg.type === 'normal'){
        console.log(msg.username, username);
        if (msg.username == username) {
          $('#messages').append('<div class="container darker" id="msgs" style = "width: 100%; margin-left: 20%; color: white"><p id="msg_text">'+msg.message+'</p><span class="time-left" style = "color: gainsboro">'+msg.time+'</span></div>')
        }else {
          $(".understood").css('visibility','hidden');
          $("#messages").append('<div class="container" id="msgs" style = "width: 80%; margin-left: 2%;"><div class="col-2"></div><div class="col-9"><p id="msg_text">'+msg.message+'</p>{% if requester %}<button class = "understood" type="button" style = "background-color: green; color: white" data-toggle="modal" data-target="#myModal">Understood</button>{% endif %}<span class="time-right">'+msg.time+'</span></div></div>')
        }
      }else{
        if (msg.type === 'connect'){
          if(msg.username != username) {
          console.log(msg.username,username);
          $('#messages').append('<li>' + msg.message + '</li>');
        }
      }
        else if(msg.type === 'exit' {% if requester %} && true {% endif %} && msg.username!=username){
         $('#messages').append('<div class="container darker" id="msgs" style = "width: 100%; margin-left: 20%; color: white"><img src="./static/img/avatar_g2.jpg" alt="Avatar" class="right"><p id="msg_text">'+msg.message+'</p><div type="button" class="btn btn-default" id = "quiz2" style = "background-color: white; color: black; border-width: 1px"><a href="/inbox?user_id={{respondent}}" style = "color: black">Exit</a></div><span class="time-left" style = "color: gainsboro">')
        }
        else{
          if(msg.type === 'quiz' {% if requester %} && true {% endif %} && msg.username!=username){
          $('#messages').append('<div class="container darker" id="msgs" style = "width: 100%; margin-left: 20%; color: white"><img src="./static/img/avatar_g2.jpg" alt="Avatar" class="right"><p id="msg_text">'+msg.message+'</p><div type="button" class="btn btn-default" id = "exit2" style = "background-color: white; color: black; border-width: 1px">OK</a></div><span class="time-left" style = "color: gainsboro">')
        }
        }

      }
      console.log('Received Message : '+msg.type);
    });

    $('#send_button').on('click', function(){
      sock.send($('#user_msg').val(),username);
      $('#user_msg').val('');
    });

    $('#exit').on('click', function(){
      sock.send("You successfully helped your requester understand the question! You may exit the chat room now",username);
    });

    $('#quiz').on('click', function(){
      sock.send("Your requester wants a quiz. Give him/her a good question!",username);
    });



    $(document).keypress(function(e) {
        if(e.which == 13) {
          if ($("#user_msg").is(":focus")) {
            sock.send($('#user_msg').val(),username);
          $('#user_msg').val('');
          }
        }
    });
  });

  $(".fa.fa-star.under").on('click', function() {
    $(this).prevAll(".fa.fa-star.under").addClass("checked");
    $(this).addClass("checked");
    $(this).nextAll(".fa.fa-star.under").removeClass("checked")
    var leng_under = $.find(".fa.under.checked").length;
    var leng_sat = $.find(".fa.sat.checked").length;
    console.log(leng_under,leng_sat);
    $(".exitanchor").attr("href","/inbox?user_id={{user_id}}&replied={{respondent}}&under="+leng_under+"&sat="+leng_sat+"&request_time={{request_time}}");
  })
  $(".fa.fa-star.sat").on('click', function() {
    $(this).prevAll(".fa.fa-star.sat").addClass("checked");
    $(this).addClass("checked");
    $(this).nextAll(".fa.fa-star.sat").removeClass("checked")
    var leng_under = $.find(".fa.under.checked").length;
    var leng_sat = $.find(".fa.sat.checked").length;
    console.log(leng_under,leng_sat);
    $(".exitanchor").attr("href","/inbox?user_id={{user_id}}&replied={{respondent}}&under="+leng_under+"&sat="+leng_sat+"&request_time={{request_time}}");
  })
  $("#show_image").on('click', function() {
    $('#messages').toggle();
    $("#image").toggle();
  })
</script>
